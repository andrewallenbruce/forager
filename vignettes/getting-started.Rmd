---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE,
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%"
  )

library(forager)
library(dplyr)
library(tidyr)
library(gt)
```

## Introduction

The `forager` package is a collection of functions that are useful for healthcare revenue cycle analysis. 

## Days in Accounts Receivable

Days in Accounts Receivable (also known as Days in AR or simply DAR) is a common financial metric belonging to a group of ratios called **efficiency ratios**. The calculation measures the average amount of time it takes for a business to collect money owed from the responsible party for services rendered and billed.

As its name implies, the unit of measurement employed by this particular metric is days, or rather the average number of days from the moment a physician provides a service until the patient or guarantor pays for that service. This number can tell you much about the financial health of the business.

The formula for calculating DAR is: 

${\textrm{Days in AR}} = \dfrac {\textrm{Ending AR Balance}} {{\textrm{Gross Charges}} \div {\textrm{Number of Days in Period}}}$


| **Variable**  | **Description**      |
:--------------:|:---------------------|
| $n_{days}$    | Days in Period       |
| $gc_t$        | Total Gross Charges  |
| $ear$         | Ending AR Balance    |
| $adc$         | Average Daily Charge |
| $dar$         | Days in AR           |
| $dart$        | Days in AR Target    |
| $eart$        | Ending AR Target       |

: DAR Formula Components.


   * Ending AR Target: $earb_{target} = (dar_{target} \times gct) \div n_{days}$
   * Gross Charges Target: $gct_{target} = (earb \times n_{days}) \div dar_{target}$
   * Days in Period Target: $n_{days} = (dar_{target} \times gct) \div earb$



```{r}
avg_dar(
  df     = dar_ex(),
  date   = date,
  gct    = gross_charges,
  earb   = ending_ar,
  dart   = 35,
  period = "month"
) |> 
  gt(rowname_col = "mon") |> 
  cols_hide(c(date, 
              nmon, 
              month, 
              nqtr, 
              yqtr, 
              dqtr, 
              year, 
              ymon, 
              myear, 
              nhalf, 
              yhalf, 
              dhalf, 
              ndip,
              ending_ar_target,
              dar_diff,
              ratio_ideal,
              ratio_actual)) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  fmt_currency(columns = c(gross_charges, 
                           ending_ar, 
                           adc, 
                           ending_ar_target, 
                           ending_ar_dec_abs, 
                           earb_gct_diff)) |> 
  fmt_tf(columns = c(dar_pass), tf_style = "check-mark") |> 
  fmt_percent(columns = c(ending_ar_dec_pct)) |> 
  fmt_number(columns = c(dar, 
                         dar_diff, 
                         ratio_actual, 
                         ratio_ideal, 
                         ratio_diff)) |> 
  cols_move_to_start(c(mon, 
                       gross_charges, 
                       ending_ar, 
                       earb_gct_diff,
                       adc, 
                       dar_pass, 
                       dar, 
                       dar_diff, 
                       ratio_actual, 
                       ratio_ideal, 
                       ratio_diff, 
                       ending_ar_target, 
                       ending_ar_dec_abs, 
                       ending_ar_dec_pct
                       )) |> 
  cols_label(
    mon = "Month",
    gross_charges = "Gross Charges",
    ending_ar = "Ending AR",
    adc = "ADC",
    dar_pass = "",
    dar = "DAR",
    ratio_diff = "AR:GC Diff",
    ending_ar_dec_abs = "AR Decrease Needed",
    ending_ar_dec_pct = "%",
    earb_gct_diff = "AR - GC"
  ) |> 
  opt_stylize()
```

```{r}
avg_dar(
  df     = dar_ex(),
  date   = date,
  gct    = gross_charges,
  earb   = ending_ar,
  dart   = 39,
  period = "quarter"
) |> 
  gt(rowname_col = "nqtr") |> 
  cols_hide(c(date, 
              nmon, 
              month,
              ndip,
              ending_ar_target,
              dar_diff,
              ratio_ideal,
              ratio_actual)) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  fmt_currency(columns = c(gross_charges, 
                           ending_ar, 
                           adc, 
                           ending_ar_target, 
                           ending_ar_dec_abs, 
                           earb_gct_diff)) |> 
  fmt_tf(columns = c(dar_pass), tf_style = "check-mark") |> 
  fmt_percent(columns = c(ending_ar_dec_pct)) |> 
  fmt_number(columns = c(dar, 
                         dar_diff, 
                         ratio_actual, 
                         ratio_ideal, 
                         ratio_diff)) |> 
  cols_move_to_start(c(nqtr, 
                       gross_charges, 
                       ending_ar, 
                       earb_gct_diff,
                       adc, 
                       dar_pass, 
                       dar, 
                       dar_diff, 
                       ratio_actual, 
                       ratio_ideal, 
                       ratio_diff, 
                       ending_ar_target, 
                       ending_ar_dec_abs, 
                       ending_ar_dec_pct
                       )) |> 
  cols_label(
    gross_charges = "Gross Charges",
    ending_ar = "Ending AR",
    adc = "ADC",
    dar_pass = "",
    dar = "DAR",
    ratio_diff = "AR:GC Diff",
    ending_ar_dec_abs = "AR Decrease Needed",
    ending_ar_dec_pct = "%",
    earb_gct_diff = "AR - GC"
  ) |> 
  opt_stylize()
```

## Aging Bins

```{r}
binned <- bin_aging(
  df = load_ex("aging_ex"),
  date = dos
  ) |>
  dplyr::select(
    dos:ins_class,
    dar:aging_bin
    )

binned
```

```{r}
binned |>
   dplyr::arrange(aging_bin) |>
   dplyr::summarise(n_claims = dplyr::n(),
                    balance = sum(charges),
                    .by = aging_bin) |>
   dplyr::mutate(
     pct_claims = n_claims / sum(n_claims),
     pct_balance = balance / sum(balance)) |> 
  gt(rowname_col = "aging_bin") |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  fmt_percent(columns = pct_claims:pct_balance, decimals = 0) |> 
  fmt_currency(columns = balance) |> 
  fmt_number(columns = n_claims, decimals = 0) |> 
  opt_stylize() |> 
  cols_label(
    n_claims = "Claims",
    pct_claims = "%",
    balance = "Charges",
    pct_balance = "%"
  ) |>
  cols_move_to_start(c(n_claims, pct_claims, balance, pct_balance)) |> 
  tab_header(
    title = "Aging Report",
  ) |>
  tab_options(
    heading.align = "left",
    quarto.disable_processing = TRUE
  )
```


```{r}
binned |>
  dplyr::arrange(aging_bin, ins_name) |>
  dplyr::summarise(
    n_claims = dplyr::n(),
    balance = sum(charges),
    .by = c(aging_bin, ins_name)
  ) |>
  dplyr::mutate(pct_claims = n_claims / sum(n_claims),
                pct_balance = balance / sum(balance)) |>
  gt() |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  fmt_percent(columns = pct_claims:pct_balance) |> 
  fmt_currency(columns = balance) |> 
  fmt_number(columns = n_claims, decimals = 0)
```


```{r}
binned |>
  dplyr::arrange(ins_name, aging_bin) |>
  dplyr::summarise(
    n_claims = dplyr::n(),
    balance = sum(charges),
    .by = c(aging_bin, ins_name)
  ) |>
  dplyr::mutate(pct_claims = n_claims / sum(n_claims),
                pct_balance = balance / sum(balance),
                .by = ins_name) |>
  gt() |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  fmt_percent(columns = pct_claims:pct_balance) |> 
  fmt_currency(columns = balance) |> 
  fmt_number(columns = n_claims, decimals = 0)
```
